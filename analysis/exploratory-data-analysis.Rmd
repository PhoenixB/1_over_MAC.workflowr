---
title: "Exploratory Data Analysis"
author: "Pascal Jerney"
date: "2021-02-27"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE}

if (!require("pacman", quietly = TRUE)) {
  install.packages("pacman")
}
pacman::p_load(
  "tidyverse",
  "conflicted",
  "fs",
  "glue",
  "ggridges"
)

conflict_prefer("select", "dplyr", quiet = TRUE)
conflict_prefer("filter", "dplyr", quiet = TRUE)

oneovermac <-
  read_rds(file = path_wd("output", "1overmac_filtered", ext = "rds")) %>%
  select(-starts_with(c("ce_mac_", "peak_alpha_")))

`%!in%` <- Negate(`%in%`)

```

## Introduction


## Data structure

```{r data_structure}

print(oneovermac, n = 20)

```

## Univariate plots

```{r univariate_plots}

oneovermac %>%
  ggplot(aes(x = peak_alpha)) +
  geom_density() +
  labs(x = "Peak alpha frequency", title = "Density of peak_alpha")

oneovermac %>%
  ggplot(aes(x = log(peak_alpha))) +
  geom_density() +
  labs(x = "Natural logarithm of peak alpha frequency", title = "Density of log(peak_alpha)")

oneovermac %>%
  ggplot(aes(x = 1/peak_alpha)) +
  geom_density() +
  labs(x = "Inverse of peak alpha frequency", title = "Density of 1/peak_alpha")

oneovermac %>%
  ggplot(aes(x = ce_mac)) +
  geom_density() +
  labs(x = "MAC at effect site", title = "Density of ce_mac")

oneovermac %>%
  ggplot(aes(x = 1/ce_mac)) +
  geom_density() +
  labs(x = "Inverse of MAC at effect site", title = "Density of 1/ce_mac") +
  scale_x_continuous(limits = c(0, 3))

```

## Bivariate plots

```{r bivariate_plots}

oneovermac %>%
    ggplot(aes(x = log(peak_alpha), y = cut_width(ce_mac, width = 0.1), fill = factor(stat(quantile)))) +
    stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, quantile_lines = TRUE, quantiles = 4) +
    labs(x = "Natural logarithm of peak alpha frequency", y = "MAC at effect site", title = "Peak alpha frequency by ceMAC", subtitle = "Fixed bin width [0.1]") + scale_fill_viridis_d(name = "Quartiles")

oneovermac %>%
    ggplot(aes(x = log(peak_alpha), y = cut_number(ce_mac, n = 25), fill = factor(stat(quantile)))) +
    stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, quantile_lines = TRUE, quantiles = 4) +
    labs(x = "Natural logarithm of peak alpha frequency", y = "MAC at effect site", title = "Peak alpha frequency by ceMAC", subtitle = "Equal number of observations per bin [25 bins]") + scale_fill_viridis_d(name = "Quartiles")

oneovermac %>%
    ggplot(aes(x = log(peak_alpha), y = cut_interval(ce_mac, n = 25), fill = factor(stat(quantile)))) +
    stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, quantile_lines = TRUE, quantiles = 4) +
    labs(x = "Natural logarithm of peak alpha frequency", y = "MAC at effect site", title = "Peak alpha frequency by ceMAC", subtitle = "Equal range [25 bins]") + scale_fill_viridis_d(name = "Quartiles")

```

## Miscellaneous plots

```{r misc_plots}

upper_boundary <- 1.5
lower_boundary <- 0.5

oneovermac %>%
  mutate(ce_mac_oor = if_else(ce_mac > upper_boundary | ce_mac < lower_boundary, "fail", "pass")) %>%
  group_by(pid, ce_mac_oor) %>%
  tally() %>%
  pivot_wider(id_cols = pid, names_from = ce_mac_oor, values_from = n, values_fill = 0) %>%
  mutate(fraction = fail/(pass+fail)) %>%
  filter(fraction > 0) %>%
  ggplot(aes(x = fraction, y = ..count..)) +
  geom_freqpoly(binwidth = 0.025) +
  labs(x = "Fraction of extreme values", y = "Patient count", title = "Fraction of extreme ceMAC values per patient (patients with 0 extreme values excluded)", subtitle = glue("Upper boundary: ", upper_boundary, ", lower boundary: ", lower_boundary))

```

## Autocorrelation plots

```{r autocorrelation}

oneovermac %>%
  select(-time) %>%
  nest() %>%
  mutate(data = map(data, ~acf(., lag.max = 1, type = "correlation", plot = FALSE))) %>%
  # mutate(data = map(data, ~as_tibble(bind_cols(lag_0 = .x$acf[1,,], lag_1 = .x$acf[2,,])))) %>%
  mutate(data = map(data, ~bind_cols(ce_mac__lag_1 = .x$acf[2,1,1], peak_alpha__lag_1 = .x$acf[2,2,2]))) %>%
  unnest(data) %>%
  pivot_longer(cols = -pid, names_to = c("variable", "lag"), names_pattern = "(.*)__lag_(.*)") %>%
  ggplot(aes(x = as.integer(pid), y = value)) +
  facet_wrap(vars(variable), scales = "free_y", labeller = labeller(variable = c("ce_mac" = "ceMAC", "peak_alpha" = "Peak alpha frequency"))) +
  geom_point() +
  labs(x = "Patient", y = "Lag 1 Autocorrelation", title = "Lag 1 Autocorrelation by variable")

oneovermac %>%
  select(-time) %>%
  nest() %>%
  mutate(data = map(data, ~acf(., lag.max = 2, type = "correlation", plot = FALSE))) %>%
  # mutate(data = map(data, ~as_tibble(bind_cols(lag_0 = .x$acf[1,,], lag_1 = .x$acf[2,,])))) %>%
  mutate(data = map(data, ~bind_cols(ce_mac__lag_2 = .x$acf[3,1,1], peak_alpha__lag_2 = .x$acf[3,2,2]))) %>%
  unnest(data) %>%
  pivot_longer(cols = -pid, names_to = c("variable", "lag"), names_pattern = "(.*)__lag_(.*)") %>%
  ggplot(aes(x = as.integer(pid), y = value)) +
  facet_wrap(vars(variable), scales = "free_y", labeller = labeller(variable = c("ce_mac" = "ceMAC", "peak_alpha" = "Peak alpha frequency"))) +
  geom_point() +
  labs(x = "Patient", y = "Lag 2 Autocorrelation", title = "Lag 2 Autocorrelation by variable")

```
